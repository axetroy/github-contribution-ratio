// ==UserScript==
// @name              github-contribution-ratio (typescript)
// @author            Axetroy
// @collaborator      Axetroy
// @description       查看Github项目的贡献比例
// @version           1.2.2
// @update            2017-04-06 21:15:43
// @grant             GM_xmlhttpRequest
// @include           https://github.com*
// @connect           *
// @compatible        chrome  完美运行
// @compatible        firefox  完美运行
// @supportURL        http://www.burningall.com
// @run-at            document-idle
// @contributionURL   troy450409405@gmail.com|alipay.com
// @downloadURL       https://github.com/axetroy/github-contribution-ratio/raw/master/dist/anti-redirect.min.user.js
// @namespace         https://greasyfork.org/zh-CN/users/3400-axetroy
// @license           The MIT License (MIT); http://opensource.org/licenses/MIT
// ==/UserScript==

// Github源码:https://github.com/axetroy/github-contribution-ratio


!function(t){function e(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var r={};e.m=t,e.c=r,e.i=function(t){return t},e.d=function(t,r,n){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:n})},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=2)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(1),o=function(){function t(t){this.options=t}return t.prototype.request=function(t,e,r,o){void 0===o&&(o={Cookie:document.cookie});var i=n({},this.options,{method:t,url:e,data:r,headers:o});return 0!==i.url.indexOf("http")&&(i.url=(i.base||"")+e),i.url+="?client_id=b8257841dd7ca5eef2aa&client_secret=4da33dd6fcb0a01d395945ad18613ecf9c12079e",new Promise(function(t,e){i.synchronous=!0,i.onreadystatechange=function(r){4===r.readyState&&(r.status>=200&&r.status<400?t(r):e(r))},i.onerror=function(t){console.error("http error"),e(t)},i.onabort=function(t){console.error("http abort"),e(t)},i.ontimeout=function(t){console.error("http timeout"),e(t)},GM_xmlhttpRequest(n({},i))})},t.prototype.get=function(t,e,r){return void 0===e&&(e=null),void 0===r&&(r={}),this.request("GET",t,e,r)},t.prototype.post=function(t,e,r){return void 0===e&&(e=null),void 0===r&&(r={}),this.request("POST",t,e,r)},t}();e.timeout=5e3;var i=new o({timeout:5e3,base:"https://api.github.com"});e.http=i},function(t,e,r){"use strict";var n=Object.prototype.hasOwnProperty,o=Object.prototype.toString,i=function(t){return"function"==typeof Array.isArray?Array.isArray(t):"[object Array]"===o.call(t)},u=function(t){if(!t||"[object Object]"!==o.call(t))return!1;var e=n.call(t,"constructor"),r=t.constructor&&t.constructor.prototype&&n.call(t.constructor.prototype,"isPrototypeOf");if(t.constructor&&!e&&!r)return!1;var i;for(i in t);return void 0===i||n.call(t,i)};t.exports=function t(){var e,r,n,o,a,c,s=arguments[0],l=1,f=arguments.length,p=!1;for("boolean"==typeof s?(p=s,s=arguments[1]||{},l=2):("object"!=typeof s&&"function"!=typeof s||null==s)&&(s={});l<f;++l)if(null!=(e=arguments[l]))for(r in e)n=s[r],o=e[r],s!==o&&(p&&o&&(u(o)||(a=i(o)))?(a?(a=!1,c=n&&i(n)?n:[]):c=n&&u(n)?n:{},s[r]=t(p,c,o)):void 0!==o&&(s[r]=o));return s}},function(t,e,r){"use strict";function n(){return location.href.match(/https:\/\/github\.com\/(\w+)\??/)[1]}function o(){return/https:\/\/github\.com\/\w+\?/.test(location.href)&&location.search.indexOf("tab=repositories")>=0}function i(){return[].slice.call(document.querySelectorAll(".js-repo-list>li")).filter(function(t){return!t.getAttribute("contribute-ratio")}).map(function(t){var e=t.querySelector("h3>a"),r=e.pathname.match(/([^\/]+)\/([^\/]+)/);return t.setAttribute("repository-owner",r[1]),t.setAttribute("repository-name",r[2]),t})}function u(){return c(this,void 0,void 0,function(){var t,e;return s(this,function(r){return o()?(t=n(),console.info("Stating "+t+"'s contribution..."),e=i(),e.length?(clearInterval(f),f=void 0,e.forEach(function(e){var r=e.getAttribute("repository-owner"),n=e.getAttribute("repository-name");l.http.get("/repos/"+r+"/"+n+"/stats/contributors").then(function(r){var n=r.response;if(n){var o=JSON.parse(n);o=0===Object.keys(o).length?[]:o;var i=o.filter(function(e){return e.author.login===t}).map(function(t){return t}),u=0,a=0,c=0,s=0;i.forEach(function(t){t.weeks.forEach(function(t){return(c+=t.a)&&(s+=t.d)})}),o.forEach(function(t){t.weeks.forEach(function(t){return(u+=t.a)&&(a+=t.d)})});var l=(c+s)/(u+a)*100+"";e.setAttribute("total-additions",u),e.setAttribute("total-deletions",a),e.setAttribute("additions",c),e.setAttribute("deletions",s),e.setAttribute("contribute-ratio",parseInt(l));var f=parseInt(l)>0?parseInt(l):1,p=document.createElement("span"),d=document.createElement("span"),h=document.createElement("span");h.setAttribute("aria-label","Contribution "+f+"%");h.classList.add("d-inline-block"),h.classList.add("tooltipped"),h.classList.add("tooltipped-s"),h.style.width="155px";var b=155*f/100;d.style.width=b+"px",d.style.borderBottom="2px solid #009688",d.style.display="inline-block",p.style.width=155-b+"px",p.style.borderBottom="2px solid #9E9E9E",p.style.display="inline-block",h.appendChild(d),h.appendChild(p),e.querySelector(".col-3.float-right.text-right").appendChild(h)}}).catch(function(t){console.error(t)})}),[2]):[2]):[2]})})}function a(){o()&&(f=setInterval(function(){u()},1500))}var c=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))(function(o,i){function u(t){try{c(n.next(t))}catch(t){i(t)}}function a(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){t.done?o(t.value):new r(function(e){e(t.value)}).then(u,a)}c((n=n.apply(t,e||[])).next())})},s=this&&this.__generator||function(t,e){function r(t){return function(e){return n([t,e])}}function n(r){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,i&&(u=i[2&r[0]?"return":r[0]?"throw":"next"])&&!(u=u.call(i,r[1])).done)return u;switch(i=0,u&&(r=[0,u.value]),r[0]){case 0:case 1:u=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,i=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(u=a.trys,!(u=u.length>0&&u[u.length-1])&&(6===r[0]||2===r[0])){a=0;continue}if(3===r[0]&&(!u||r[1]>u[0]&&r[1]<u[3])){a.label=r[1];break}if(6===r[0]&&a.label<u[1]){a.label=u[1],u=r;break}if(u&&a.label<u[2]){a.label=u[2],a.ops.push(r);break}u[2]&&a.ops.pop(),a.trys.pop();continue}r=e.call(t,a)}catch(t){r=[6,t],i=0}finally{o=u=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var o,i,u,a={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return{next:r(0),throw:r(1),return:r(2)}};Object.defineProperty(e,"__esModule",{value:!0});var l=r(0);!function(t){var e=t.pushState;t.pushState=function(r){return"function"==typeof t.onpushstate&&t.onpushstate({state:r}),setTimeout(function(){a()}),e.apply(t,arguments)}}(window.history);var f;a()}]);